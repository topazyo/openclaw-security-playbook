#!/usr/bin/env python3
"""
Weekly Vulnerability Report Generator

Purpose: Generate executive PDF reports with vulnerability trends and metrics
Attack Vectors: Visibility gap, management awareness, compliance evidence
Compliance: SOC 2 CC7.1, ISO 27001 A.12.6.1, evidence collection

Generates:
- CVSS score distribution charts
- Vulnerability trends (12-week rolling)
- Patching velocity metrics
- Top vulnerable packages
- Service breakdown
- Executive summary

Usage:
    python3 generate-weekly-report.py --output report.pdf
    python3 generate-weekly-report.py --weeks 12 --email security-team@openclaw.ai

Dependencies: matplotlib, pandas, reportlab, elasticsearch

Related: os-scan.sh, dashboard-system-health.json
"""

import argparse
import json
import logging
import os
import sys
from datetime import datetime, timedelta
from typing import Dict, List
from io import BytesIO

try:
    import matplotlib
    matplotlib.use('Agg')  # Non-interactive backend
    import matplotlib.pyplot as plt
    import pandas as pd
    from reportlab.lib.pagesizes import letter, A4
    from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
    from reportlab.lib.units import inch
    from reportlab.lib import colors
    from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle, Image, PageBreak
    from reportlab.lib.enums import TA_CENTER, TA_LEFT, TA_RIGHT
    from elasticsearch import Elasticsearch
except ImportError:
    print("ERROR: Missing dependencies. Install with:")
    print("pip install matplotlib pandas reportlab elasticsearch")
    sys.exit(1)

# Configuration
ES_URL = os.getenv("ELASTICSEARCH_URL", "http://localhost:9200")
ES_INDEX_PATTERN = "openclaw-vulnerabilities-*"
REPORT_WEEKS = 12

# Logging
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)


class VulnerabilityReportGenerator:
    """Generate comprehensive vulnerability reports"""
    
    def __init__(self, es_url: str, weeks: int = 12):
        self.es = Elasticsearch([es_url])
        self.weeks = weeks
        self.start_date = datetime.now() - timedelta(weeks=weeks)
        self.styles = getSampleStyleSheet()
        self._setup_styles()
    
    def _setup_styles(self):
        """Setup custom report styles"""
        self.styles.add(ParagraphStyle(
            name='CustomTitle',
            parent=self.styles['Heading1'],
            fontSize=24,
            textColor=colors.HexColor('#1a1a1a'),
            spaceAfter=30,
            alignment=TA_CENTER
        ))
        
        self.styles.add(ParagraphStyle(
            name='SectionHeader',
            parent=self.styles['Heading2'],
            fontSize=16,
            textColor=colors.HexColor('#2c3e50'),
            spaceAfter=12,
            spaceBefore=12
        ))
    
    def fetch_vulnerability_data(self) -> List[Dict]:
        """Fetch vulnerability data from Elasticsearch"""
        logger.info(f"Fetching vulnerability data from past {self.weeks} weeks...")
        
        query = {
            "query": {
                "bool": {
                    "must": [
                        {"range": {"@timestamp": {"gte": self.start_date.isoformat()}}}
                    ]
                }
            },
            "size": 10000,
            "sort": [{"@timestamp": "desc"}]
        }
        
        try:
            response = self.es.search(index=ES_INDEX_PATTERN, body=query)
            hits = response['hits']['hits']
            logger.info(f"Fetched {len(hits)} vulnerability records")
            return [hit['_source'] for hit in hits]
        except Exception as e:
            logger.error(f"Failed to fetch data from Elasticsearch: {e}")
            return []
    
    def calculate_metrics(self, data: List[Dict]) -> Dict:
        """Calculate key vulnerability metrics"""
        df = pd.DataFrame(data)
        
        if df.empty:
            return {
                "total_vulns": 0,
                "by_severity": {},
                "avg_cvss": 0,
                "patched_count": 0,
                "patch_rate": 0
            }
        
        # Extract nested vulnerability data
        vulns = []
        for item in data:
            vuln_data = item.get('vulnerability', {})
            vulns.append({
                'severity': vuln_data.get('severity', 'UNKNOWN'),
                'cvss_score': vuln_data.get('cvss_score', 0),
                'package_name': vuln_data.get('package_name', ''),
                'fixed_version': vuln_data.get('fixed_version', 'N/A'),
                'timestamp': item.get('@timestamp', '')
            })
        
        vuln_df = pd.DataFrame(vulns)
        
        # Calculate metrics
        by_severity = vuln_df['severity'].value_counts().to_dict()
        total_vulns = len(vuln_df)
        avg_cvss = vuln_df['cvss_score'].mean() if not vuln_df.empty else 0
        patched_count = len(vuln_df[vuln_df['fixed_version'] != 'N/A'])
        patch_rate = (patched_count / total_vulns * 100) if total_vulns > 0 else 0
        
        return {
            "total_vulns": total_vulns,
            "by_severity": by_severity,
            "avg_cvss": round(avg_cvss, 2),
            "patched_count": patched_count,
            "patch_rate": round(patch_rate, 1),
            "dataframe": vuln_df
        }
    
    def create_cvss_distribution_chart(self, df: pd.DataFrame) -> str:
        """Create CVSS score distribution histogram"""
        fig, ax = plt.subplots(figsize=(8, 5))
        
        if not df.empty:
            ax.hist(df['cvss_score'], bins=20, color='#3498db', edgecolor='black', alpha=0.7)
            ax.axvline(df['cvss_score'].mean(), color='red', linestyle='--', linewidth=2, label=f'Mean: {df["cvss_score"].mean():.2f}')
        
        ax.set_xlabel('CVSS Score', fontsize=12)
        ax.set_ylabel('Frequency', fontsize=12)
        ax.set_title('CVSS Score Distribution', fontsize=14, fontweight='bold')
        ax.legend()
        ax.grid(True, alpha=0.3)
        
        # Save to bytes
        buf = BytesIO()
        plt.savefig(buf, format='png', dpi=150, bbox_inches='tight')
        buf.seek(0)
        plt.close()
        
        return buf
    
    def create_severity_pie_chart(self, by_severity: Dict) -> str:
        """Create severity breakdown pie chart"""
        fig, ax = plt.subplots(figsize=(8, 6))
        
        if by_severity:
            colors_map = {
                'CRITICAL': '#e74c3c',
                'HIGH': '#f39c12',
                'MEDIUM': '#3498db',
                'LOW': '#2ecc71'
            }
            
            labels = list(by_severity.keys())
            sizes = list(by_severity.values())
            colors_list = [colors_map.get(label, '#95a5a6') for label in labels]
            
            ax.pie(sizes, labels=labels, autopct='%1.1f%%', startangle=90, colors=colors_list)
            ax.set_title('Vulnerabilities by Severity', fontsize=14, fontweight='bold')
        
        buf = BytesIO()
        plt.savefig(buf, format='png', dpi=150, bbox_inches='tight')
        buf.seek(0)
        plt.close()
        
        return buf
    
    def create_trend_chart(self, df: pd.DataFrame) -> str:
        """Create vulnerability trend over time"""
        fig, ax = plt.subplots(figsize=(10, 5))
        
        if not df.empty and 'timestamp' in df.columns:
            df['timestamp'] = pd.to_datetime(df['timestamp'])
            df_grouped = df.groupby(df['timestamp'].dt.to_period('W')).size()
            
            weeks = df_grouped.index.to_timestamp()
            counts = df_grouped.values
            
            ax.plot(weeks, counts, marker='o', linewidth=2, markersize=6, color='#3498db')
            ax.fill_between(weeks, counts, alpha=0.3, color='#3498db')
        
        ax.set_xlabel('Week', fontsize=12)
        ax.set_ylabel('Vulnerability Count', fontsize=12)
        ax.set_title(f'Vulnerability Trend ({self.weeks} Weeks)', fontsize=14, fontweight='bold')
        ax.grid(True, alpha=0.3)
        plt.xticks(rotation=45)
        
        buf = BytesIO()
        plt.savefig(buf, format='png', dpi=150, bbox_inches='tight')
        buf.seek(0)
        plt.close()
        
        return buf
    
    def create_top_packages_table(self, df: pd.DataFrame) -> List[List]:
        """Create table of top vulnerable packages"""
        if df.empty:
            return [['Package', 'Count', 'Avg CVSS']]
        
        top_packages = df.groupby('package_name').agg({
            'package_name': 'count',
            'cvss_score': 'mean'
        }).rename(columns={'package_name': 'count'}).nlargest(10, 'count')
        
        table_data = [['Package', 'Vulnerabilities', 'Avg CVSS']]
        for pkg, row in top_packages.iterrows():
            table_data.append([
                pkg[:30],  # Truncate long package names
                str(int(row['count'])),
                f"{row['cvss_score']:.1f}"
            ])
        
        return table_data
    
    def generate_report(self, output_path: str) -> bool:
        """Generate complete PDF report"""
        logger.info("Generating vulnerability report...")
        
        # Fetch data
        data = self.fetch_vulnerability_data()
        if not data:
            logger.warning("No vulnerability data found")
            data = []
        
        # Calculate metrics
        metrics = self.calculate_metrics(data)
        df = metrics.get('dataframe', pd.DataFrame())
        
        # Create PDF
        doc = SimpleDocTemplate(output_path, pagesize=letter)
        story = []
        
        # Title
        title = Paragraph("OpenClaw Security<br/>Weekly Vulnerability Report", self.styles['CustomTitle'])
        story.append(title)
        story.append(Spacer(1, 0.3*inch))
        
        # Report metadata
        report_date = datetime.now().strftime("%B %d, %Y")
        period = f"{self.start_date.strftime('%b %d, %Y')} - {datetime.now().strftime('%b %d, %Y')}"
        
        meta = Paragraph(f"<b>Report Date:</b> {report_date}<br/><b>Period:</b> {period}", self.styles['Normal'])
        story.append(meta)
        story.append(Spacer(1, 0.5*inch))
        
        # Executive Summary
        story.append(Paragraph("Executive Summary", self.styles['SectionHeader']))
        
        summary_text = f"""
        During the {self.weeks}-week reporting period, the vulnerability scanning system identified 
        <b>{metrics['total_vulns']}</b> total vulnerabilities across the infrastructure. 
        The average CVSS score is <b>{metrics['avg_cvss']}</b>, with <b>{metrics['patched_count']}</b> 
        vulnerabilities having available patches (patch availability rate: <b>{metrics['patch_rate']}%</b>).
        """
        
        story.append(Paragraph(summary_text, self.styles['Normal']))
        story.append(Spacer(1, 0.3*inch))
        
        # Key Metrics Table
        metrics_data = [
            ['Metric', 'Value'],
            ['Total Vulnerabilities', str(metrics['total_vulns'])],
            ['Average CVSS Score', str(metrics['avg_cvss'])],
            ['Patches Available', f"{metrics['patched_count']} ({metrics['patch_rate']}%)"],
            ['CRITICAL', str(metrics['by_severity'].get('CRITICAL', 0))],
            ['HIGH', str(metrics['by_severity'].get('HIGH', 0))],
            ['MEDIUM', str(metrics['by_severity'].get('MEDIUM', 0))],
            ['LOW', str(metrics['by_severity'].get('LOW', 0))]
        ]
        
        metrics_table = Table(metrics_data, colWidths=[3*inch, 2*inch])
        metrics_table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), colors.grey),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
            ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, 0), 12),
            ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
            ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
            ('GRID', (0, 0), (-1, -1), 1, colors.black)
        ]))
        
        story.append(metrics_table)
        story.append(Spacer(1, 0.5*inch))
        
        # Charts
        if not df.empty:
            # CVSS Distribution
            story.append(PageBreak())
            story.append(Paragraph("CVSS Score Distribution", self.styles['SectionHeader']))
            cvss_chart = self.create_cvss_distribution_chart(df)
            story.append(Image(cvss_chart, width=6*inch, height=3.5*inch))
            story.append(Spacer(1, 0.3*inch))
            
            # Severity Breakdown
            story.append(Paragraph("Severity Breakdown", self.styles['SectionHeader']))
            severity_chart = self.create_severity_pie_chart(metrics['by_severity'])
            story.append(Image(severity_chart, width=6*inch, height=4*inch))
            
            # Trend Chart
            story.append(PageBreak())
            story.append(Paragraph("Vulnerability Trend", self.styles['SectionHeader']))
            trend_chart = self.create_trend_chart(df)
            story.append(Image(trend_chart, width=7*inch, height=4*inch))
            story.append(Spacer(1, 0.3*inch))
            
            # Top Packages Table
            story.append(PageBreak())
            story.append(Paragraph("Top 10 Vulnerable Packages", self.styles['SectionHeader']))
            
            packages_data = self.create_top_packages_table(df)
            packages_table = Table(packages_data, colWidths=[3*inch, 1.5*inch, 1.5*inch])
            packages_table.setStyle(TableStyle([
                ('BACKGROUND', (0, 0), (-1, 0), colors.grey),
                ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
                ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
                ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                ('FONTSIZE', (0, 0), (-1, 0), 11),
                ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
                ('BACKGROUND', (0, 1), (-1, -1), colors.white),
                ('GRID', (0, 0), (-1, -1), 1, colors.black),
                ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.white, colors.lightgrey])
            ]))
            
            story.append(packages_table)
        
        # Recommendations
        story.append(PageBreak())
        story.append(Paragraph("Recommendations", self.styles['SectionHeader']))
        
        recommendations = [
            "1. Prioritize remediation of CRITICAL and HIGH severity vulnerabilities within SLA deadlines (7 days and 30 days respectively per SEC-003 policy)",
            "2. Review top 10 vulnerable packages and consider package alternatives or version upgrades",
            "3. Implement automated patching for LOW severity vulnerabilities using auto-remediate.sh",
            "4. Schedule patch deployment during defined maintenance windows (03:00-05:00 UTC)",
            "5. Verify patch effectiveness with post-deployment scans and update Jira tickets with evidence"
        ]
        
        for rec in recommendations:
            story.append(Paragraph(rec, self.styles['Normal']))
            story.append(Spacer(1, 0.1*inch))
        
        # Footer
        story.append(Spacer(1, 0.5*inch))
        footer_text = "<i>Generated by openclaw-security vulnerability management system</i>"
        story.append(Paragraph(footer_text, self.styles['Normal']))
        
        # Build PDF
        try:
            doc.build(story)
            logger.info(f"Report saved to: {output_path}")
            return True
        except Exception as e:
            logger.error(f"Failed to generate report: {e}")
            return False


def main():
    parser = argparse.ArgumentParser(
        description="Generate weekly vulnerability PDF report",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
    # Generate report for last 12 weeks
    python3 generate-weekly-report.py --output weekly-report.pdf
    
    # Custom time period
    python3 generate-weekly-report.py --weeks 8 --output report-8weeks.pdf
    
    # With custom Elasticsearch URL
    ELASTICSEARCH_URL=https://elk.openclaw.ai:9200 python3 generate-weekly-report.py

Environment Variables:
    ELASTICSEARCH_URL    Elasticsearch endpoint (default: http://localhost:9200)

Output:
    PDF report with:
    - Executive summary
    - Vulnerability metrics
    - CVSS distribution
    - Severity breakdown
    - Vulnerability trends
    - Top vulnerable packages
    - Remediation recommendations
        """
    )
    
    parser.add_argument(
        "--output",
        default=f"vulnerability-report-{datetime.now().strftime('%Y%m%d')}.pdf",
        help="Output PDF file path"
    )
    parser.add_argument(
        "--weeks",
        type=int,
        default=REPORT_WEEKS,
        help=f"Number of weeks to include (default: {REPORT_WEEKS})"
    )
    parser.add_argument(
        "--es-url",
        default=ES_URL,
        help=f"Elasticsearch URL (default: {ES_URL})"
    )
    
    args = parser.parse_args()
    
    # Generate report
    generator = VulnerabilityReportGenerator(args.es_url, args.weeks)
    
    if generator.generate_report(args.output):
        logger.info(f"✓ Report generated successfully: {args.output}")
        return 0
    else:
        logger.error("✗ Report generation failed")
        return 1


if __name__ == "__main__":
    sys.exit(main())
