# nginx.secure.conf
# Secure Nginx configuration template for ClawdBot AI Agent Gateway
# 
# This configuration provides production-grade security including:
# - TLS 1.3 with strong ciphers
# - mTLS (mutual TLS) for client authentication
# - Rate limiting and connection limits
# - IP whitelisting for VPN access only
# - Security headers (HSTS, CSP, X-Frame-Options, etc.)
# - Request size limits
# - Access logging with sensitive data filtering
# - Health check endpoint
# - WebSocket support (if needed)
#
# Usage:
#   1. Copy to /etc/nginx/sites-available/clawdbot
#   2. Customize variables marked with <PLACEHOLDER>
#   3. Generate SSL certificates (Let's Encrypt or internal CA)
#   4. Test: nginx -t
#   5. Enable: ln -s /etc/nginx/sites-available/clawdbot /etc/nginx/sites-enabled/
#   6. Reload: systemctl reload nginx
#
# Tested on: Nginx 1.24+, Ubuntu 22.04+, Debian 11+
# Last Updated: February 14, 2026

# ============================================================================
# GLOBAL CONFIGURATION (include in main nginx.conf)
# ============================================================================

# Uncomment and add to /etc/nginx/nginx.conf if not already present:

# user nginx;
# worker_processes auto;
# worker_rlimit_nofile 65535;
# error_log /var/log/nginx/error.log warn;
# pid /var/run/nginx.pid;
# 
# events {
#     worker_connections 4096;
#     use epoll;
#     multi_accept on;
# }

# ============================================================================
# HTTP BLOCK CONFIGURATION
# ============================================================================

# Place this in http {} block of /etc/nginx/nginx.conf:

# Basic settings
# sendfile on;
# tcp_nopush on;
# tcp_nodelay on;
# keepalive_timeout 65;
# keepalive_requests 100;
# types_hash_max_size 2048;
# server_tokens off;  # Hide Nginx version

# Buffer settings (prevent buffer overflow attacks)
# client_body_buffer_size 10K;
# client_header_buffer_size 1k;
# client_max_body_size 10m;  # Maximum request body size
# large_client_header_buffers 2 1k;

# Timeout settings (prevent slowloris attacks)
# client_body_timeout 12;
# client_header_timeout 12;
# send_timeout 10;

# ============================================================================
# RATE LIMITING ZONES
# ============================================================================
# Define these in the http {} block

# Rate limit: 10 requests per second per IP
limit_req_zone $binary_remote_addr zone=clawdbot_req_limit:10m rate=10r/s;

# Rate limit for login/auth endpoints: 5 requests per minute
limit_req_zone $binary_remote_addr zone=clawdbot_auth_limit:10m rate=5r/m;

# Connection limit: 10 concurrent connections per IP
limit_conn_zone $binary_remote_addr zone=clawdbot_conn_limit:10m;

# Limit request size for specific endpoints
limit_req_zone $binary_remote_addr zone=clawdbot_heavy_limit:10m rate=2r/s;

# ============================================================================
# LOGGING CONFIGURATION
# ============================================================================

# Custom log format that filters sensitive data
log_format secure_log '$remote_addr - $remote_user [$time_local] '
                      '"$request_method $request_uri $server_protocol" '
                      '$status $body_bytes_sent '
                      '"$http_referer" "$http_user_agent" '
                      'rt=$request_time uct="$upstream_connect_time" '
                      'uht="$upstream_header_time" urt="$upstream_response_time"';

# Map to identify loggable requests (filter out sensitive data)
map $request_uri $loggable {
    ~*api_key       0;  # Don't log requests with api_key in URL
    ~*token         0;  # Don't log requests with token in URL
    ~*password      0;  # Don't log requests with password in URL
    ~*secret        0;  # Don't log requests with secret in URL
    ~*credential    0;  # Don't log requests with credential in URL
    default         1;  # Log everything else
}

# ============================================================================
# UPSTREAM BACKEND CONFIGURATION
# ============================================================================

upstream clawdbot_backend {
    # Backend server configuration
    # Option 1: Unix socket (recommended for same-host deployment)
    # server unix:/var/run/clawdbot.sock fail_timeout=10s max_fails=3;

    # Option 2: TCP localhost (if socket not available)
    server 127.0.0.1:18789 fail_timeout=10s max_fails=3;

    # Option 3: Docker container (if using Docker)
    # server clawdbot:18789 fail_timeout=10s max_fails=3;

    # Option 4: Multiple backends with load balancing
    # server 127.0.0.1:18789 weight=2;
    # server 127.0.0.1:18790 weight=1 backup;

    # Keepalive connections (improves performance)
    keepalive 32;
    keepalive_requests 100;
    keepalive_timeout 60s;
}

# ============================================================================
# GEO-BLOCKING CONFIGURATION (OPTIONAL)
# ============================================================================

# Block requests from specific countries (requires GeoIP2 module)
# Uncomment if you have ngx_http_geoip2_module installed

# geoip2 /usr/share/GeoIP/GeoLite2-Country.mmdb {
#     auto_reload 60m;
#     $geoip2_data_country_code country iso_code;
# }
# 
# map $geoip2_data_country_code $blocked_country {
#     default 0;
#     CN 1;  # China
#     RU 1;  # Russia
#     KP 1;  # North Korea
#     IR 1;  # Iran
# }

# ============================================================================
# SSL/TLS CONFIGURATION
# ============================================================================

# SSL session cache (shared across workers)
ssl_session_cache shared:SSL:10m;
ssl_session_timeout 10m;
ssl_session_tickets off;  # Disable for forward secrecy

# SSL protocols (TLS 1.2 and 1.3 only)
ssl_protocols TLSv1.2 TLSv1.3;

# SSL ciphers (strong ciphers only)
ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
ssl_prefer_server_ciphers off;  # Let client choose (TLS 1.3 best practice)

# OCSP Stapling (verify certificate status)
ssl_stapling on;
ssl_stapling_verify on;
ssl_trusted_certificate /etc/nginx/ssl/chain.pem;  # <PLACEHOLDER: Your CA chain>
resolver 8.8.8.8 8.8.4.4 valid=300s;
resolver_timeout 5s;

# ============================================================================
# HTTPS SERVER BLOCK (PRIMARY)
# ============================================================================

server {
    # Listen on port 443 with HTTP/2 and SSL
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    # Server name
    server_name clawdbot.company.internal;  # <PLACEHOLDER: Your domain>

    # ========================================================================
    # SSL CERTIFICATES
    # ========================================================================

    # Server certificate and key
    ssl_certificate /etc/nginx/ssl/clawdbot.crt;      # <PLACEHOLDER: Your cert>
    ssl_certificate_key /etc/nginx/ssl/clawdbot.key;  # <PLACEHOLDER: Your key>

    # ========================================================================
    # MUTUAL TLS (mTLS) - CLIENT CERTIFICATE AUTHENTICATION
    # ========================================================================
    # Uncomment to enable client certificate verification

    # Require client certificate
    # ssl_client_certificate /etc/nginx/ssl/client-ca.crt;  # <PLACEHOLDER: Client CA>
    # ssl_verify_client on;       # Require valid client cert
    # ssl_verify_depth 2;         # Max chain depth

    # OR use optional verification (check in application)
    # ssl_verify_client optional;
    # ssl_verify_depth 2;

    # ========================================================================
    # SECURITY HEADERS
    # ========================================================================

    # HTTP Strict Transport Security (force HTTPS for 1 year)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # Prevent clickjacking
    add_header X-Frame-Options "DENY" always;

    # Prevent MIME type sniffing
    add_header X-Content-Type-Options "nosniff" always;

    # XSS protection (legacy, but doesn't hurt)
    add_header X-XSS-Protection "1; mode=block" always;

    # Referrer policy
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Content Security Policy (strict)
    add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self';" always;

    # Permissions Policy (disable unnecessary features)
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), accelerometer=(), gyroscope=()" always;

    # ========================================================================
    # ACCESS CONTROL - IP WHITELISTING
    # ========================================================================

    # Allow access only from VPN subnets
    # IMPORTANT: Customize these to your VPN IP ranges

    # Tailscale subnet
    allow 100.64.0.0/10;     # Tailscale CGNAT range

    # WireGuard subnet (example)
    allow 10.0.0.0/8;        # <PLACEHOLDER: Your WireGuard subnet>

    # OpenVPN subnet (example)
    allow 10.8.0.0/24;       # <PLACEHOLDER: Your OpenVPN subnet>

    # Office network (if direct access needed)
    # allow 203.0.113.0/24;  # <PLACEHOLDER: Your office IP range>

    # Localhost (for health checks)
    allow 127.0.0.1;
    allow ::1;

    # Block everything else
    deny all;

    # ========================================================================
    # GEO-BLOCKING (OPTIONAL)
    # ========================================================================
    # Uncomment if you configured GeoIP2 above

    # if ($blocked_country) {
    #     return 403 "Access denied from your country";
    # }

    # ========================================================================
    # RATE LIMITING
    # ========================================================================

    # General rate limit: 10 req/s, allow burst of 20
    limit_req zone=clawdbot_req_limit burst=20 nodelay;

    # Connection limit: 10 concurrent connections per IP
    limit_conn clawdbot_conn_limit 10;

    # ========================================================================
    # LOGGING
    # ========================================================================

    # Access log (filter sensitive data)
    access_log /var/log/nginx/clawdbot-access.log secure_log if=$loggable;

    # Error log
    error_log /var/log/nginx/clawdbot-error.log warn;

    # ========================================================================
    # ROOT LOCATION (MAIN PROXY)
    # ========================================================================

    location / {
        # Additional rate limiting for this location
        # limit_req zone=clawdbot_req_limit burst=20 nodelay;

        # Proxy pass to backend
        proxy_pass http://clawdbot_backend;

        # Protocol version
        proxy_http_version 1.1;

        # ====================================================================
        # PROXY HEADERS
        # ====================================================================

        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # WebSocket support (if needed)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Client certificate info (if using mTLS)
        # proxy_set_header X-Client-Cert $ssl_client_cert;
        # proxy_set_header X-Client-DN $ssl_client_s_dn;
        # proxy_set_header X-Client-Verify $ssl_client_verify;

        # Security: Remove headers that might leak info
        proxy_hide_header X-Powered-By;
        proxy_hide_header Server;

        # ====================================================================
        # TIMEOUTS
        # ====================================================================

        # Connection timeout to backend
        proxy_connect_timeout 60s;

        # Timeout for sending request to backend
        proxy_send_timeout 60s;

        # Timeout for reading response from backend
        proxy_read_timeout 60s;

        # ====================================================================
        # BUFFERING
        # ====================================================================

        # Enable buffering (recommended for most cases)
        proxy_buffering on;

        # Buffer size for response headers
        proxy_buffer_size 4k;

        # Number and size of buffers for response body
        proxy_buffers 8 4k;

        # Maximum size of data to buffer before writing to temp file
        proxy_busy_buffers_size 8k;

        # Disable temp file buffering (for large responses)
        proxy_max_temp_file_size 0;

        # ====================================================================
        # CACHING (OPTIONAL)
        # ====================================================================
        # Uncomment if you want to cache responses

        # proxy_cache clawdbot_cache;
        # proxy_cache_valid 200 5m;
        # proxy_cache_valid 404 1m;
        # proxy_cache_bypass $http_cache_control;
        # add_header X-Cache-Status $upstream_cache_status;
    }

    # ========================================================================
    # HEALTH CHECK ENDPOINT
    # ========================================================================

    location = /health {
        # No rate limiting for health checks
        limit_req off;
        limit_conn off;

        # Allow from monitoring systems
        allow 127.0.0.1;
        allow ::1;
        allow 10.0.0.0/8;      # <PLACEHOLDER: Your monitoring subnet>
        allow 100.64.0.0/10;   # Tailscale
        deny all;

        # Don't log health checks (reduces noise)
        access_log off;

        # Proxy to backend
        proxy_pass http://clawdbot_backend/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;

        # Short timeouts for health checks
        proxy_connect_timeout 5s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;
    }

    # ========================================================================
    # METRICS ENDPOINT (PROMETHEUS)
    # ========================================================================

    location = /metrics {
        # Strict IP whitelist for metrics
        allow 127.0.0.1;
        allow ::1;
        allow 10.0.0.0/8;      # <PLACEHOLDER: Your monitoring subnet>
        deny all;

        # No rate limiting for metrics scraping
        limit_req off;

        # Don't log metrics requests
        access_log off;

        # Proxy to backend
        proxy_pass http://clawdbot_backend/metrics;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # ========================================================================
    # AUTHENTICATION ENDPOINTS (STRICTER RATE LIMITING)
    # ========================================================================

    location ~ ^/(auth|login|token) {
        # Strict rate limit: 5 requests per minute
        limit_req zone=clawdbot_auth_limit burst=3 nodelay;

        # Proxy to backend
        proxy_pass http://clawdbot_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Shorter timeouts for auth
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # ========================================================================
    # HEAVY/EXPENSIVE ENDPOINTS (VERY STRICT RATE LIMITING)
    # ========================================================================

    location ~ ^/(v1/completions|v1/messages) {
        # Very strict rate limit: 2 requests per second
        limit_req zone=clawdbot_heavy_limit burst=5 nodelay;

        # Proxy to backend
        proxy_pass http://clawdbot_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Longer timeouts for AI completions
        proxy_connect_timeout 60s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }

    # ========================================================================
    # ADMIN ENDPOINTS (MOST RESTRICTIVE)
    # ========================================================================

    location ~ ^/admin {
        # Super strict IP whitelist
        allow 127.0.0.1;
        allow ::1;
        # allow 10.0.0.10;  # <PLACEHOLDER: Specific admin IPs>
        deny all;

        # Strict rate limit
        limit_req zone=clawdbot_auth_limit burst=2 nodelay;

        # Require basic auth (in addition to other security)
        # auth_basic "Administrator Area";
        # auth_basic_user_file /etc/nginx/.htpasswd;

        # Proxy to backend
        proxy_pass http://clawdbot_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ========================================================================
    # STATIC FILES (IF ANY)
    # ========================================================================

    # location /static/ {
    #     alias /var/www/clawdbot/static/;
    #     expires 1d;
    #     add_header Cache-Control "public, immutable";
    # }

    # ========================================================================
    # DENY ACCESS TO SENSITIVE FILES
    # ========================================================================

    # Deny access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Deny access to backup files
    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Deny access to config files
    location ~ \.(yml|yaml|json|conf|config)$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # ========================================================================
    # ERROR PAGES
    # ========================================================================

    # Custom error pages (optional)
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;

    # location = /404.html {
    #     root /var/www/clawdbot/errors;
    #     internal;
    # }
    # 
    # location = /50x.html {
    #     root /var/www/clawdbot/errors;
    #     internal;
    # }
}

# ============================================================================
# HTTP SERVER BLOCK (REDIRECT TO HTTPS)
# ============================================================================

server {
    # Listen on port 80 (HTTP)
    listen 80;
    listen [::]:80;

    # Server name
    server_name clawdbot.company.internal;  # <PLACEHOLDER: Your domain>

    # Redirect all HTTP traffic to HTTPS
    return 301 https://$server_name$request_uri;

    # Alternative: Return error for HTTP requests
    # return 426 "HTTPS Required";
}

# ============================================================================
# STUB STATUS (NGINX METRICS) - OPTIONAL
# ============================================================================

server {
    listen 127.0.0.1:8080;
    server_name localhost;

    location /nginx_status {
        stub_status on;
        access_log off;

        # Only allow from localhost
        allow 127.0.0.1;
        deny all;
    }
}

# ============================================================================
# NOTES AND CUSTOMIZATION CHECKLIST
# ============================================================================

# Before deploying, customize these placeholders:
# 
# [ ] server_name - Your domain name
# [ ] ssl_certificate - Path to your SSL certificate
# [ ] ssl_certificate_key - Path to your SSL private key
# [ ] ssl_trusted_certificate - Path to your CA chain
# [ ] ssl_client_certificate - Path to client CA (if using mTLS)
# [ ] IP whitelist ranges (allow directives)
# [ ] Backend server address (upstream block)
# [ ] Log paths (if different from defaults)
# [ ] Admin IP addresses (in /admin location)
# 
# Optional customizations:
# [ ] Enable/configure mTLS client certificates
# [ ] Enable/configure GeoIP blocking
# [ ] Adjust rate limits based on your needs
# [ ] Configure caching (if needed)
# [ ] Add custom error pages
# [ ] Configure static file serving (if needed)
# [ ] Enable basic auth for admin endpoints
# 
# Testing:
# [ ] Test configuration: sudo nginx -t
# [ ] Test SSL: openssl s_client -connect domain:443
# [ ] Test mTLS (if enabled): curl --cert client.crt --key client.key https://domain
# [ ] Test rate limiting: ab -n 100 -c 10 https://domain/
# [ ] Verify headers: curl -I https://domain
# [ ] Check security score: https://www.ssllabs.com/ssltest/
# 
# Monitoring:
# [ ] Set up log rotation for access/error logs
# [ ] Configure log forwarding to SIEM
# [ ] Set up alerts for 429 (rate limit) responses
# [ ] Monitor upstream health
# [ ] Track SSL certificate expiration

# ============================================================================
# SECURITY SCORE TARGETS
# ============================================================================
# 
# After configuration, verify you achieve:
# - SSL Labs: A+ rating
# - Mozilla Observatory: A+ rating
# - Security Headers: A+ rating
# 
# Run these tests:
# 1. SSL Labs: https://www.ssllabs.com/ssltest/
# 2. Security Headers: https://securityheaders.com/
# 3. Mozilla Observatory: https://observatory.mozilla.org/

# ============================================================================
# END OF CONFIGURATION
# ============================================================================
