# HashiCorp Vault Secrets Template
# Path: secret/openclaw/agent/
#
# Purpose: Secrets management for OpenClaw agents
# Provider: HashiCorp Vault (KV Secrets Engine v2)
#
# Usage:
#   1. Create secrets in Vault:
#      vault kv put secret/openclaw/agent/encryption_keys @encryption_keys.json
#   
#   2. Grant agent access via policy:
#      vault policy write openclaw-agent openclaw-agent-policy.hcl
#   
#   3. Create AppRole for agent authentication:
#      vault write auth/approle/role/openclaw-agent \
#        token_ttl=1h \
#        token_max_ttl=4h \
#        policies="openclaw-agent"
#   
#   4. Agent retrieves secrets:
#      export VAULT_ADDR="https://vault.openclaw.ai"
#      export VAULT_TOKEN="s.xxxxxxxxxxxxxxxx"
#      openclaw-agent --config openclaw-agent.yml --env production
#
# Rotation Schedule:
#   - Encryption keys: Every 90 days (automated)
#   - API tokens: Every 180 days (manual)
#   - TLS certificates: Every 365 days (automated via cert-manager)
#   - Database credentials: Every 90 days (manual)
#
# Compliance:
#   - SOC 2 CC6.1: Secrets stored encrypted at rest
#   - ISO 27001 A.10.1.2: Key management
#   - GDPR Article 32: Security of processing

# ============================================================================
# ENCRYPTION KEYS
# ============================================================================
# Path: secret/openclaw/agent/encryption_keys
# Purpose: AES-256-GCM encryption keys for data at rest
# Rotation: Every 90 days (automated via cron job)
# Format: Base64-encoded 32-byte keys
#
# Generate new key:
#   openssl rand -base64 32
#
# Vault command:
#   vault kv put secret/openclaw/agent/encryption_keys \
#     current_key="REPLACE_WITH_BASE64_KEY" \
#     previous_key="REPLACE_WITH_PREVIOUS_KEY" \
#     key_id="20260215-001" \
#     rotation_date="2026-02-15T00:00:00Z" \
#     rotation_schedule="0 0 */90 * *"

path "secret/data/openclaw/agent/encryption_keys" {
  # Example secret structure (DO NOT store actual keys here):
  # {
  #   "current_key": "BASE64_ENCODED_32_BYTE_KEY",
  #   "previous_key": "BASE64_ENCODED_PREVIOUS_KEY",
  #   "key_id": "20260215-001",
  #   "rotation_date": "2026-02-15T00:00:00Z",
  #   "rotation_schedule": "0 0 */90 * *",
  #   "algorithm": "AES-256-GCM",
  #   "key_length_bits": 256
  # }
}

# ============================================================================
# API TOKENS
# ============================================================================
# Path: secret/openclaw/agent/api_tokens
# Purpose: External API authentication tokens
# Rotation: Every 180 days (manual review and rotation)
#
# Vault command:
#   vault kv put secret/openclaw/agent/api_tokens \
#     jira_api_token="REPLACE_WITH_JIRA_TOKEN" \
#     pagerduty_integration_key="REPLACE_WITH_PAGERDUTY_KEY" \
#     slack_webhook_url="https://hooks.slack.com/services/REPLACE" \
#     elasticsearch_api_key="REPLACE_WITH_ES_API_KEY" \
#     virustotal_api_key="REPLACE_WITH_VT_API_KEY" \
#     abuseipdb_api_key="REPLACE_WITH_ABUSEIPDB_KEY"

path "secret/data/openclaw/agent/api_tokens" {
  # Example secret structure:
  # {
  #   "jira_api_token": "ATATTxxxxxxxxxxxxxxxx",
  #   "jira_url": "https://openclaw.atlassian.net",
  #   "jira_project_key": "SEC",
  #   "pagerduty_integration_key": "R1xxxxxxxxxxxxxxxxxxxxxxx",
  #   "pagerduty_routing_key": "R1xxxxxxxxxxxxxxxxxxxxxxx",
  #   "pagerduty_service_id": "PXXXXXx",
  #   "slack_webhook_url": "https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX",
  #   "slack_channel_critical": "#security-incidents",
  #   "slack_channel_high": "#security-alerts",
  #   "elasticsearch_api_key": "BASE64_ENCODED_API_KEY",
  #   "elasticsearch_id": "xxxxxxxxxxxxxxxx",
  #   "virustotal_api_key": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  #   "abuseipdb_api_key": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  #   "alienvault_otx_api_key": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
  # }
}

# ============================================================================
# TLS CERTIFICATES
# ============================================================================
# Path: secret/openclaw/agent/tls_certs
# Purpose: mTLS client certificates for agent authentication
# Rotation: Every 365 days (automated via cert-manager/Let's Encrypt)
# Format: PEM-encoded X.509 certificates and RSA/ECDSA private keys
#
# Generate self-signed cert (dev only):
#   openssl req -x509 -newkey rsa:4096 -keyout agent.key -out agent.crt \
#     -days 365 -nodes -subj "/CN=openclaw-agent-prod"
#
# Vault command:
#   vault kv put secret/openclaw/agent/tls_certs \
#     agent_cert=@agent.crt \
#     agent_key=@agent.key \
#     ca_bundle=@ca.crt \
#     expiry_date="2027-02-15T00:00:00Z"

path "secret/data/openclaw/agent/tls_certs" {
  # Example secret structure:
  # {
  #   "agent_cert": "-----BEGIN CERTIFICATE-----\nMIIFxxxxxxxxxxxxxxxx...\n-----END CERTIFICATE-----",
  #   "agent_key": "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQE...\n-----END PRIVATE KEY-----",
  #   "ca_bundle": "-----BEGIN CERTIFICATE-----\nMIIDxxxxxxxxxxxxxxxx...\n-----END CERTIFICATE-----",
  #   "cert_serial": "1A:2B:3C:4D:5E:6F",
  #   "issuer": "CN=OpenClaw CA,O=OpenClaw,C=US",
  #   "subject": "CN=openclaw-agent-prod,O=OpenClaw,C=US",
  #   "not_before": "2026-02-15T00:00:00Z",
  #   "not_after": "2027-02-15T00:00:00Z",
  #   "expiry_days": 365,
  #   "key_type": "RSA",
  #   "key_size_bits": 4096,
  #   "signature_algorithm": "SHA256-RSA"
  # }
}

# ============================================================================
# DATABASE CREDENTIALS
# ============================================================================
# Path: secret/openclaw/agent/database
# Purpose: Database connection credentials (PostgreSQL, Redis, Elasticsearch)
# Rotation: Every 90 days (manual via DBA procedures)
#
# Vault command (PostgreSQL example):
#   vault kv put secret/openclaw/agent/database \
#     postgres_url="postgresql://openclaw_agent:PASSWORD@db.openclaw.ai:5432/openclaw" \
#     redis_url="redis://:PASSWORD@redis.openclaw.ai:6379/0" \
#     elasticsearch_username="openclaw_agent" \
#     elasticsearch_password="REPLACE_WITH_PASSWORD"

path "secret/data/openclaw/agent/database" {
  # Example secret structure:
  # {
  #   "postgres_url": "postgresql://openclaw_agent:STRONG_PASSWORD@db.openclaw.ai:5432/openclaw",
  #   "postgres_host": "db.openclaw.ai",
  #   "postgres_port": 5432,
  #   "postgres_database": "openclaw",
  #   "postgres_username": "openclaw_agent",
  #   "postgres_password": "STRONG_PASSWORD",
  #   "postgres_ssl_mode": "require",
  #   "redis_url": "redis://:STRONG_PASSWORD@redis.openclaw.ai:6379/0",
  #   "redis_host": "redis.openclaw.ai",
  #   "redis_port": 6379,
  #   "redis_database": 0,
  #   "redis_password": "STRONG_PASSWORD",
  #   "redis_tls_enabled": true,
  #   "elasticsearch_url": "https://elk.openclaw.ai:9200",
  #   "elasticsearch_username": "openclaw_agent",
  #   "elasticsearch_password": "STRONG_PASSWORD",
  #   "elasticsearch_api_key_id": "xxxxxxxxxxxxxxxx",
  #   "elasticsearch_api_key": "BASE64_ENCODED_KEY"
  # }
}

# ============================================================================
# OAUTH2 CREDENTIALS
# ============================================================================
# Path: secret/openclaw/agent/oauth2
# Purpose: OAuth2 client credentials for authentication providers
# Rotation: Every 180 days (coordinate with identity provider)
#
# Vault command:
#   vault kv put secret/openclaw/agent/oauth2 \
#     client_id="REPLACE_WITH_CLIENT_ID" \
#     client_secret="REPLACE_WITH_CLIENT_SECRET" \
#     provider="Auth0" \
#     authorization_endpoint="https://auth.openclaw.ai/authorize"

path "secret/data/openclaw/agent/oauth2" {
  # Example secret structure:
  # {
  #   "provider": "Auth0",
  #   "client_id": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  #   "client_secret": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  #   "tenant": "openclaw",
  #   "domain": "openclaw.auth0.com",
  #   "authorization_endpoint": "https://openclaw.auth0.com/authorize",
  #   "token_endpoint": "https://openclaw.auth0.com/oauth/token",
  #   "userinfo_endpoint": "https://openclaw.auth0.com/userinfo",
  #   "jwks_uri": "https://openclaw.auth0.com/.well-known/jwks.json",
  #   "issuer": "https://openclaw.auth0.com/",
  #   "audience": "openclaw-mcp",
  #   "scopes": ["openid", "profile", "email"],
  #   "grant_type": "client_credentials"
  # }
}

# ============================================================================
# AWS CREDENTIALS
# ============================================================================
# Path: secret/openclaw/agent/aws
# Purpose: AWS IAM credentials for S3 backups and CloudWatch logging
# Rotation: Every 90 days (automated via AWS STS temporary credentials)
# Note: Prefer IAM roles over access keys when possible
#
# Vault command:
#   vault kv put secret/openclaw/agent/aws \
#     access_key_id="AKIA..." \
#     secret_access_key="REPLACE_WITH_SECRET_KEY" \
#     region="us-east-1"

path "secret/data/openclaw/agent/aws" {
  # Example secret structure:
  # {
  #   "access_key_id": "AKIAxxxxxxxxxxxxxxxx",
  #   "secret_access_key": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  #   "region": "us-east-1",
  #   "s3_bucket_backups": "openclaw-backups-prod",
  #   "s3_bucket_logs": "openclaw-logs-prod",
  #   "cloudwatch_log_group": "/aws/openclaw/agent",
  #   "cloudwatch_log_stream": "openclaw-agent-prod",
  #   "iam_role_arn": "arn:aws:iam::123456789012:role/openclaw-agent",
  #   "session_duration_seconds": 3600,
  #   "mfa_required": false
  # }
}

# ============================================================================
# SIGNING KEYS
# ============================================================================
# Path: secret/openclaw/agent/signing_keys
# Purpose: GPG/PGP keys for signing skills and forensic evidence
# Rotation: Every 730 days (2 years)
# Format: ASCII-armored PGP private key
#
# Generate new key:
#   gpg --full-generate-key --expert
#   gpg --armor --export-secret-keys security@openclaw.ai > private.key
#
# Vault command:
#   vault kv put secret/openclaw/agent/signing_keys \
#     gpg_private_key=@private.key \
#     gpg_public_key=@public.key \
#     passphrase="REPLACE_WITH_STRONG_PASSPHRASE"

path "secret/data/openclaw/agent/signing_keys" {
  # Example secret structure:
  # {
  #   "gpg_private_key": "-----BEGIN PGP PRIVATE KEY BLOCK-----\n...\n-----END PGP PRIVATE KEY BLOCK-----",
  #   "gpg_public_key": "-----BEGIN PGP PUBLIC KEY BLOCK-----\n...\n-----END PGP PUBLIC KEY BLOCK-----",
  #   "gpg_key_id": "0xABCDEF1234567890",
  #   "gpg_fingerprint": "ABCD EF12 3456 7890 1234  5678 90AB CDEF 1234 5678",
  #   "passphrase": "STRONG_PASSPHRASE_FOR_PRIVATE_KEY",
  #   "email": "security@openclaw.ai",
  #   "name": "OpenClaw Security Team",
  #   "created_date": "2026-02-15T00:00:00Z",
  #   "expiry_date": "2028-02-15T00:00:00Z",
  #   "key_type": "RSA",
  #   "key_size_bits": 4096
  # }
}

# ============================================================================
# VAULT POLICY
# ============================================================================
# Policy name: openclaw-agent
# Purpose: Grant OpenClaw agents read-only access to secrets
# Apply with: vault policy write openclaw-agent openclaw-agent-policy.hcl

# Read-only access to encryption keys
path "secret/data/openclaw/agent/encryption_keys" {
  capabilities = ["read", "list"]
}

# Read-only access to API tokens
path "secret/data/openclaw/agent/api_tokens" {
  capabilities = ["read", "list"]
}

# Read-only access to TLS certificates
path "secret/data/openclaw/agent/tls_certs" {
  capabilities = ["read", "list"]
}

# Read-only access to database credentials
path "secret/data/openclaw/agent/database" {
  capabilities = ["read", "list"]
}

# Read-only access to OAuth2 credentials
path "secret/data/openclaw/agent/oauth2" {
  capabilities = ["read", "list"]
}

# Read-only access to AWS credentials
path "secret/data/openclaw/agent/aws" {
  capabilities = ["read", "list"]
}

# Read-only access to signing keys
path "secret/data/openclaw/agent/signing_keys" {
  capabilities = ["read", "list"]
}

# List secrets in agent namespace
path "secret/metadata/openclaw/agent/*" {
  capabilities = ["list"]
}

# Deny all other paths (explicit deny)
path "*" {
  capabilities = ["deny"]
}

# ============================================================================
# AUDIT LOGGING
# ============================================================================
# Enable Vault audit logging for compliance (SOC 2 CC7.2)
# Command:
#   vault audit enable file file_path=/var/log/vault/audit.log
#
# Audit log includes:
#   - All secret read operations (who, when, which secret)
#   - Failed authentication attempts
#   - Policy violations
#   - Token creation/revocation
#
# Retention: 7 years (2555 days) for SOC 2 Type II compliance
# Storage: Forward to Elasticsearch openclaw-vault-audit-* index

# ============================================================================
# SECURITY BEST PRACTICES
# ============================================================================
# 
# 1. NEVER commit this file with actual secrets to version control
#    - This is a TEMPLATE only
#    - Real secrets belong in Vault, not in Git
# 
# 2. Use strong, unique passwords for each secret
#    - Minimum 32 characters
#    - Mix uppercase, lowercase, numbers, symbols
#    - Use password manager or: openssl rand -base64 32
# 
# 3. Rotate secrets regularly
#    - Encryption keys: 90 days
#    - API tokens: 180 days
#    - TLS certificates: 365 days
#    - Database passwords: 90 days
# 
# 4. Limit secret access via policies
#    - Principle of least privilege
#    - Grant read-only access when possible
#    - Audit all secret access
# 
# 5. Use temporary credentials when possible
#    - AWS STS temporary credentials (1-12 hours)
#    - Vault dynamic secrets (auto-revoked)
#    - OAuth2 short-lived tokens (1 hour)
# 
# 6. Monitor secret access
#    - Alert on unusual access patterns
#    - Review audit logs weekly
#    - Revoke compromised credentials immediately
# 
# 7. Encrypt secrets at rest
#    - Vault auto-encrypts with AES-256-GCM
#    - Master key stored in HSM or cloud KMS
#    - Enable Vault seal wrap for extra protection
# 
# 8. Backup Vault data
#    - Daily snapshots to encrypted S3
#    - Test restoration quarterly
#    - Store backup encryption keys offline
# 
# 9. Use AppRole for agent authentication
#    - Bind AppRole to specific CIDR ranges
#    - Rotate role_id and secret_id regularly
#    - Limit token TTL to minimum required
# 
# 10. Compliance documentation
#     - Document all secret types and rotation schedules
#     - Maintain access logs for audits
#     - Provide evidence of encryption for SOC 2/ISO 27001
