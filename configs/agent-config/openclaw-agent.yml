# OpenClaw Agent Configuration
# Reference configuration template for openclaw-shield agent deployment
# 
# Usage: openclaw-agent --config openclaw-agent.yml --env production
#        (loads environment-specific overrides from environment-overrides.yml)
#
# Environment Variables:
#   OPENCLAW_AGENT_ID       - Unique agent identifier (UUID)
#   MCP_SERVER_HOST         - MCP server hostname/IP
#   MCP_SERVER_PORT         - MCP server port (default: 8443)
#   ELASTICSEARCH_URL       - Elasticsearch cluster URL
#   ELASTICSEARCH_USERNAME  - Elasticsearch username
#   ELASTICSEARCH_PASSWORD  - Elasticsearch password (use Vault)
#   REDIS_URL               - Redis URL for rate limiting
#   VAULT_ADDR              - HashiCorp Vault address
#   VAULT_TOKEN             - Vault authentication token
#   PROMETHEUS_PORT         - Prometheus metrics port (default: 9090)

# Agent Identity
# Unique identifier for this agent instance
agent:
  id: ${OPENCLAW_AGENT_ID}
  name: "openclaw-agent-prod"
  version: "2.1.0"
  environment: "production"  # Values: development, staging, production
  
  # Agent capabilities and resource limits
  capabilities:
    max_concurrent_tasks: 10
    max_task_duration_seconds: 300
    memory_limit_mb: 2048
    cpu_limit_cores: 2.0

# Security Controls
# SOC 2 CC6.1, ISO 27001 A.14.1.2 (Input validation)
security_controls:
  
  # Input Validation
  # Protects against prompt injection, XSS, SQL injection, path traversal
  # References: examples/security-controls/input-validation.py
  input_validation:
    enabled: true
    
    # Maximum payload size to prevent DoS
    max_payload_size_mb: 10
    
    # Allowed content types for request payloads
    allowed_content_types:
      - "application/json"
      - "text/plain"
      - "text/markdown"
    
    # Sanitization rules applied to all inputs
    # Patterns defined in configs/skill-policies/dangerous-patterns.json
    sanitization_rules:
      - "xss"              # Cross-site scripting prevention
      - "sql_injection"    # SQL injection prevention
      - "path_traversal"   # Directory traversal prevention
      - "command_injection" # OS command injection prevention
      - "nosql_injection"  # NoSQL injection prevention
    
    # Character encoding normalization
    unicode_normalization: "NFC"  # Unicode Normalization Form C
    
    # Maximum nesting depth for JSON/YAML
    max_nesting_depth: 10
    
    # Reject inputs with null bytes
    reject_null_bytes: true
  
  # Rate Limiting
  # SOC 2 CC6.1, ISO 27001 A.14.1.3 (Availability)
  # References: examples/security-controls/rate-limiting.py
  rate_limiting:
    enabled: true
    
    # Token bucket algorithm parameters
    algorithm: "token_bucket"
    
    # Global rate limits
    requests_per_minute: 100
    burst_size: 20  # Additional requests allowed in burst
    
    # Redis for distributed rate limiting across multiple agents
    redis_url: ${REDIS_URL}
    redis_db: 0
    redis_key_prefix: "openclaw:ratelimit:"
    
    # Per-user rate limits (stricter than global)
    per_user_limits:
      requests_per_minute: 50
      burst_size: 10
    
    # Per-IP rate limits (prevent abuse from single source)
    per_ip_limits:
      requests_per_minute: 200
      burst_size: 40
    
    # Rate limit response
    http_status_code: 429  # Too Many Requests
    retry_after_seconds: 60
  
  # Authentication & Authorization
  # SOC 2 CC6.2, ISO 27001 A.9.2.1 (User access management)
  # References: examples/security-controls/authentication.py
  authentication:
    # Supported methods: mTLS, OAuth2, API_Key
    method: "mTLS"
    
    # Mutual TLS configuration
    mtls:
      enabled: true
      ca_cert_path: "/etc/openclaw/ca.crt"
      client_cert_required: true
      verify_depth: 3
      crl_check: true
      crl_url: "https://ca.openclaw.ai/crl"
    
    # OAuth2 configuration (if method: OAuth2)
    oauth2:
      enabled: false
      provider: "Auth0"  # Auth0, Okta, Custom
      client_id: ${OAUTH2_CLIENT_ID}
      client_secret: ${OAUTH2_CLIENT_SECRET}
      token_endpoint: "https://auth.openclaw.ai/token"
      userinfo_endpoint: "https://auth.openclaw.ai/userinfo"
      jwks_uri: "https://auth.openclaw.ai/.well-known/jwks.json"
      audience: "openclaw-mcp"
      scopes: ["openid", "profile", "email"]
    
    # API Key configuration (if method: API_Key)
    api_key:
      enabled: false
      header_name: "X-OpenClaw-API-Key"
      key_prefix: "oc_"
      min_key_length: 32
    
    # Token/session settings
    token_expiry_seconds: 3600  # 1 hour
    refresh_token_expiry_seconds: 86400  # 24 hours
    token_cache_enabled: true
    token_cache_ttl_seconds: 300  # 5 minutes
    
    # Multi-factor authentication
    mfa_required: true
    mfa_providers:
      - "totp"      # Time-based One-Time Password
      - "webauthn"  # WebAuthn/FIDO2
    mfa_grace_period_days: 7  # Days to enroll MFA for new users
    
    # Session management
    max_concurrent_sessions: 3
    session_timeout_seconds: 3600
    idle_timeout_seconds: 1800  # 30 minutes
  
  # Authorization (RBAC)
  # SOC 2 CC6.3, ISO 27001 A.9.2.3 (Privileged access management)
  authorization:
    enabled: true
    rbac_enabled: true
    
    # Default role for unauthenticated users
    default_role: "guest"
    
    # Admin roles with elevated privileges
    admin_roles:
      - "admin"
      - "security-ops"
      - "incident-response"
    
    # Role-based permissions
    # Permissions: read, write, delete, execute, admin
    permissions:
      guest:
        - "read"
      user:
        - "read"
        - "write"
      developer:
        - "read"
        - "write"
        - "execute"
      admin:
        - "read"
        - "write"
        - "execute"
        - "delete"
        - "admin"
  
  # Encryption
  # SOC 2 CC6.1, ISO 27001 A.10.1.1 (Cryptographic controls)
  # References: examples/security-controls/encryption.py
  encryption:
    # Encryption algorithm for data at rest
    algorithm: "AES-256-GCM"
    
    # Key management via HashiCorp Vault
    vault_url: ${VAULT_ADDR}
    vault_token: ${VAULT_TOKEN}
    vault_path: "secret/openclaw/agent/encryption_keys"
    
    # Key rotation schedule (days)
    key_rotation_days: 90
    
    # Encrypt sensitive data in logs/storage
    encrypt_pii: true
    encrypt_credentials: true
    encrypt_conversation_history: true
    
    # TLS for data in transit
    tls_enabled: true
    tls_min_version: "1.3"
    tls_ciphersuites:
      - "TLS_AES_256_GCM_SHA384"
      - "TLS_CHACHA20_POLY1305_SHA256"
  
  # Logging & Audit
  # SOC 2 CC7.2, ISO 27001 A.12.4.1 (Event logging)
  # References: examples/security-controls/logging.py
  logging:
    # Log format (json for ECS compatibility)
    format: "json"
    
    # Log level (DEBUG, INFO, WARN, ERROR, CRITICAL)
    level: "INFO"
    
    # Log retention (7 years for SOC 2 Type II)
    retention_days: 2555
    
    # Elasticsearch index pattern
    index_pattern: "openclaw-logs-*"
    
    # Fields to log
    log_fields:
      - "timestamp"
      - "level"
      - "agent_id"
      - "user_id"
      - "source_ip"
      - "request_id"
      - "action"
      - "resource"
      - "outcome"
      - "duration_ms"
    
    # PII redaction (replace sensitive data)
    redact_pii: true
    redact_patterns:
      - "ssn"          # Social Security Numbers
      - "credit_card"  # Credit card numbers
      - "email"        # Email addresses
      - "api_key"      # API keys
      - "password"     # Passwords
    
    # Tamper-evident logging (SHA-256 hash chains)
    tamper_evident: true
    hash_algorithm: "SHA-256"
    
    # Log security events
    log_authentication: true
    log_authorization: true
    log_data_access: true
    log_configuration_changes: true
    log_errors: true

# MCP Server Configuration
# Model Context Protocol server connection settings
mcp_server:
  # Server connection
  host: ${MCP_SERVER_HOST}
  port: ${MCP_SERVER_PORT:-8443}
  
  # TLS configuration
  tls_config:
    enabled: true
    verify_certs: true
    ca_cert_path: "/etc/openclaw/ca.crt"
    client_cert_path: "/etc/openclaw/agent.crt"
    client_key_path: "/etc/openclaw/agent.key"
    min_version: "1.3"
    max_version: "1.3"
  
  # API version
  api_version: "v1"
  
  # Connection timeouts
  connect_timeout_seconds: 10
  request_timeout_seconds: 30
  
  # Connection pooling
  max_connections: 100
  keepalive_enabled: true
  keepalive_interval_seconds: 60
  
  # Retry configuration
  retry_enabled: true
  retry_max_attempts: 3
  retry_backoff_seconds: 1

# Monitoring & Observability
# SOC 2 CC7.2, ISO 27001 A.12.4.1 (Monitoring)
monitoring:
  # Elasticsearch for centralized logging
  elasticsearch:
    url: ${ELASTICSEARCH_URL}
    username: ${ELASTICSEARCH_USERNAME}
    password: ${ELASTICSEARCH_PASSWORD}
    index_prefix: "openclaw-logs-"
    
    # Bulk indexing settings
    bulk_size: 100
    bulk_flush_interval_seconds: 5
    
    # TLS configuration
    tls_enabled: true
    verify_certs: true
    ca_cert_path: "/etc/openclaw/ca.crt"
  
  # Prometheus metrics
  prometheus:
    enabled: true
    port: ${PROMETHEUS_PORT:-9090}
    path: "/metrics"
    
    # Metrics to expose
    metrics:
      - "http_requests_total"
      - "http_request_duration_seconds"
      - "http_request_size_bytes"
      - "http_response_size_bytes"
      - "authentication_attempts_total"
      - "authentication_failures_total"
      - "rate_limit_exceeded_total"
      - "encryption_operations_total"
      - "encryption_operation_duration_seconds"
  
  # Health checks
  health_check:
    enabled: true
    port: 8080
    path: "/health"
    interval_seconds: 30
  
  # Tracing (OpenTelemetry)
  tracing:
    enabled: false
    provider: "jaeger"  # jaeger, zipkin, datadog
    endpoint: "http://jaeger.openclaw.ai:14268/api/traces"
    sample_rate: 0.1  # 10% sampling

# Compliance Settings
# SOC 2, ISO 27001, GDPR, PCI DSS
compliance:
  # SOC 2 Type II compliance
  soc2_enabled: true
  soc2_controls:
    - "CC6.1"  # Logical and physical access controls
    - "CC6.2"  # Authentication and authorization
    - "CC6.3"  # Privileged access management
    - "CC7.1"  # Threat detection and monitoring
    - "CC7.2"  # Event logging and analysis
    - "CC7.3"  # Incident response
  
  # ISO 27001:2022 compliance
  iso27001_enabled: true
  iso27001_controls:
    - "A.9.2.1"   # User registration and de-registration
    - "A.9.2.3"   # Management of privileged access rights
    - "A.10.1.1"  # Cryptographic controls
    - "A.12.4.1"  # Event logging
    - "A.14.1.2"  # Securing application services
    - "A.16.1.4"  # Assessment of and decision on information security events
  
  # GDPR compliance
  gdpr_enabled: true
  gdpr_settings:
    data_retention_days: 2555  # 7 years
    right_to_erasure: true
    data_portability: true
    breach_notification_hours: 72  # Article 33
    consent_required: true
  
  # PCI DSS compliance (if processing payment data)
  pci_dss_enabled: false
  pci_dss_controls:
    - "3.4"   # Render PAN unreadable
    - "6.2"   # Patch vulnerabilities
    - "10.2"  # Audit trail for system components

# Skill Configuration
# Controls for skill execution and permissions
# References: configs/skill-policies/
skills:
  # Skill installation settings
  auto_install: false
  auto_update: false
  require_signature: true
  
  # Skill permissions (allowlist approach)
  allowlist_path: "configs/skill-policies/allowlist.json"
  
  # Dangerous pattern detection
  dangerous_patterns_path: "configs/skill-policies/dangerous-patterns.json"
  
  # Skill execution limits
  max_execution_time_seconds: 60
  max_memory_mb: 512
  max_cpu_percent: 50
  
  # Network access restrictions
  network_restrictions:
    allow_outbound: false
    allowed_domains:
      - "api.openclaw.ai"
      - "*.openclaw.ai"
    blocked_ports:
      - 22    # SSH
      - 3306  # MySQL
      - 5432  # PostgreSQL
  
  # File system restrictions
  filesystem_restrictions:
    read_only: true
    allowed_paths:
      - "/tmp/openclaw/skills"
      - "/var/openclaw/data"
    blocked_paths:
      - "/etc"
      - "/root"
      - "/home"

# Backup & Disaster Recovery
# SOC 2 CC9.1, ISO 27001 A.12.3.1 (Information backup)
backup:
  enabled: true
  
  # Backup schedule (cron format)
  schedule: "0 2 * * *"  # Daily 2 AM UTC
  
  # Backup retention
  retention_daily: 7
  retention_weekly: 4
  retention_monthly: 12
  
  # Backup storage
  storage:
    type: "s3"
    bucket: "openclaw-backups-prod"
    region: "us-east-1"
    encryption: "AES256"
    storage_class: "GLACIER"
  
  # Backup verification
  verify_backups: true
  verify_schedule: "0 3 * * 0"  # Weekly Sunday 3 AM UTC
  
  # Recovery objectives
  rto_hours: 4   # Recovery Time Objective
  rpo_minutes: 15  # Recovery Point Objective

# Feature Flags
# Toggle features without redeployment
feature_flags:
  experimental_features_enabled: false
  beta_features_enabled: false
  
  # Circuit breakers for external dependencies
  circuit_breaker:
    enabled: true
    failure_threshold: 5
    timeout_seconds: 10
    reset_timeout_seconds: 60
